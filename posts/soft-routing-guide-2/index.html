<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>【教程二】软路由pve、openwrt安装,上网配置教程 -</title><meta name=Description content="This is my cool site"><meta property="og:title" content="【教程二】软路由pve、openwrt安装,上网配置教程"><meta property="og:description" content="组网方式介绍对比,主路由、旁路由、单臂路由。pve安装，虚拟平台安装openwrt。img用StarWind V2V Converter转换为vmdk，镜像写入U盘 rufus。openwrt怎么联网，上网配置。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.hughh.top/posts/soft-routing-guide-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-09T21:38:20+08:00"><meta property="article:modified_time" content="2022-10-23T22:15:27+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="【教程二】软路由pve、openwrt安装,上网配置教程"><meta name=twitter:description content="组网方式介绍对比,主路由、旁路由、单臂路由。pve安装，虚拟平台安装openwrt。img用StarWind V2V Converter转换为vmdk，镜像写入U盘 rufus。openwrt怎么联网，上网配置。"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.hughh.top/posts/soft-routing-guide-2/><link rel=prev href=https://www.hughh.top/posts/soft-routing-guide-1/><link rel=next href=https://www.hughh.top/posts/soft-routing-guide-3/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"【教程二】软路由pve、openwrt安装,上网配置教程","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.hughh.top\/posts\/soft-routing-guide-2\/"},"genre":"posts","wordcount":1705,"url":"https:\/\/www.hughh.top\/posts\/soft-routing-guide-2\/","datePublished":"2022-10-09T21:38:20+08:00","dateModified":"2022-10-23T22:15:27+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"阿修"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title><img class="lazyload logo" src=/svg/loading.min.svg data-src=/onion.png data-srcset="/onion.png, /onion.png 1.5x, /onion.png 2x" data-sizes=auto alt=/onion.png title=/onion.png>阿修的博客</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=https://github.com/Hugh357 rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw" aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img class="lazyload logo" src=/svg/loading.min.svg data-src=/onion.png data-srcset="/onion.png, /onion.png 1.5x, /onion.png 2x" data-sizes=auto alt=/onion.png title=/onion.png>阿修的博客</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=https://github.com/Hugh357 title rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">【教程二】软路由pve、openwrt安装,上网配置教程</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>阿修</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E8%BD%AF%E8%B7%AF%E7%94%B1%E6%95%99%E7%A8%8B/><i class="far fa-folder fa-fw" aria-hidden=true></i>软路由教程</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-10-09>2022-10-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 1705 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/post3-openwrt.jpg data-srcset="/post3-openwrt.jpg, /post3-openwrt.jpg 1.5x, /post3-openwrt.jpg 2x" data-sizes=auto alt=/post3-openwrt.jpg title=/post3-openwrt.jpg></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#一组网方式>一、组网方式</a></li><li><a href=#二物理机安装pve>二、物理机安装pve</a><ul><li><a href=#21-对比esxi>2.1 对比esxi</a></li><li><a href=#22-安装步骤>2.2 安装步骤</a></li></ul></li><li><a href=#三安装openwrt虚拟机网卡直通>三、安装openwrt虚拟机、网卡直通</a></li><li><a href=#四openwrt上网设置>四、openwrt上网设置</a></li></ul></nav></div></div><div class=content id=content><h2 id=一组网方式>一、组网方式</h2><p>博主是4网口的N5105机器，虚拟平台是pve，固件是OpenWrt-Rpi</p><p>用的是openwrt做主路由的组网方式，硬路由直负责无线AP</p><p>软路由一共有 主路由、旁路由、单臂路由三种组网方式。进一步了解也可以参考视频：<a href=https://www.bilibili.com/video/BV1Xt4y1e7zq/ target=_blank rel="noopener noreffer">软路由入坑指南！</a>，如下。也可以谷歌本文中的关键字作为学习路线。</p><div class=bilibili><iframe src="//player.bilibili.com/player.html?bvid=BV1Xt4y1e7zq&page=1" scrolling=no border=0 frameborder=no framespacing=0 allowfullscreen></iframe></div><p><br></br></p><h2 id=二物理机安装pve>二、物理机安装pve</h2><p>下面进入安装环节，如果看过上一篇文章，在VMware中安装过软路由，应该会更顺手。博主在工控机上用的虚拟平台是pve</p><p>固件下载和工具下载见上一篇文章： <a href=/posts/%e6%95%99%e7%a8%8b%e4%b8%80%e8%bd%af%e8%b7%af%e7%94%b1%e4%bb%8b%e7%bb%8d%e5%9b%ba%e4%bb%b6%e4%bd%bf%e7%94%a8%e4%bd%93%e9%aa%8c%e5%af%b9%e6%af%94 rel>【教程一】软路由介绍固件使用体验对比</a></p><h3 id=21-对比esxi>2.1 对比esxi</h3><p>pve是开源的虚拟平台，安装方便。</p><p>esxi出自VMware，需要官网注册新账号去申请试用才能下载，安装后需要激活，安装步骤稍麻烦，7.0版本还有虚拟闪存占用整个磁盘的bug，最后esxi没法查看物理机温度</p><p>pve可以通过安装软件，然后修改web去实现温度显示</p><p><br></br></p><h3 id=22-安装步骤>2.2 安装步骤</h3><p>和普通装系统一样，先将iso文件用rufus写入U盘，开机进BIOS，U盘启动</p><p>如果有多块硬盘别装错位置就行，按图形界面填写信息，密码也不像esxi有复杂度要求。重启后，到同一网段，访问 ip:8006</p><p>主要注意ip的设置，以及如何从你当前的路由器切换到openwrt</p><p>我的建议是不要和当前路由器在同一个网段，比如当前路由器是192.168.1.1，那么pve的ip就设置为192.168.100.2，未来openwrt设置为192.168.100.1</p><p>这样的缺点是你的电脑只能用网线连接pve，不能连当前上网的路由器，这样就断网不能查资料了，优点是两个路由器在两个网段，不会搞混</p><p>实际上博主的尝试中，即使在同一个网段，两个路由器lan口桥接到pve也没法相互访问，电脑连pve都访问不了</p><p><br></br></p><h2 id=三安装openwrt虚拟机网卡直通>三、安装openwrt虚拟机、网卡直通</h2><p>建议安装pve后，立马安装openwrt并拨号上网，这样就能一直连着pve并能上网查资料了</p><p>上传虚img镜像，并<strong>复制路径</strong>，如果弹窗关闭了，可以在pve界面下面的日志中点开</p><p>添加虚拟机，勾选高级，勾选开机启动，<strong>记住vmid</strong>，一般是100</p><p>CPU插槽拉满，核心的话，看你物理CPU是几核几线程的，一般选1或2，类型选host</p><p>硬盘删掉，后续从命令行挂载img做硬盘</p><p>网络就默认的，会给你一个桥接的口，<strong>取消勾选防火墙</strong></p><p>完成后，先别开机，点到刚刚创建的虚拟机-硬件</p><ol><li>挂载硬盘，进入pve命令行，可以ssh，运行</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qm importdisk <span class=o>[</span>vmid<span class=o>]</span> <span class=o>[</span>img路径<span class=o>]</span> local-lvm
</span></span></code></pre></div><ol start=2><li><p>回到虚拟机-硬件，编辑出现的一个未使用磁盘，选择SCSI，<strong>点击添加</strong></p></li><li><p>网卡直通，博主是4网口的，一个网口是pve管理端口，不可直通，而且这个已经桥接，可以连接pve、openwrt、台式机网线</p><p>需再直通两个网口，一个连光猫的wan口，一个给无线路由器AP的lan口</p><p>选择添加PCI设备，找到网卡添加</p></li><li><p>设置uefi引导，虚拟机-选项-引导顺序，选刚刚的磁盘</p></li><li><p>开机</p></li><li><p>网络设置</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/config/network
</span></span><span class=line><span class=cl><span class=c1># 把eht0改到和自己电脑相同网段的，没人用的ip</span>
</span></span><span class=line><span class=cl><span class=c1># service network restart</span>
</span></span><span class=line><span class=cl><span class=c1># 建议使用reboot，稳一点</span>
</span></span><span class=line><span class=cl>reboot
</span></span></code></pre></div><p>找到一个lan的，改ipaddr到同一网段，这就是日后的路由器ip地址</p><ol start=7><li>更改镜像源地址 - 可选</li></ol><p>使用国内源安装依赖</p><p>这里博主选腾讯云的镜像地址，因为软路由的openwrt固件中普遍用到了Snapshot，而阿里云的镜像中没有</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># https://www.hughh.top</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/Hugh357/hugh357.github.io</span>
</span></span><span class=line><span class=cl><span class=c1># 操作前备份</span>
</span></span><span class=line><span class=cl>cp /etc/opkg/distfeeds.conf /etc/opkg/distfeeds.conf.bk
</span></span><span class=line><span class=cl><span class=c1># 替换镜像地址</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s_downloads.openwrt.org_mirrors.cloud.tencent.com/openwrt_&#39;</span> /etc/opkg/distfeeds.conf
</span></span></code></pre></div><p><br></br></p><h2 id=四openwrt上网设置>四、openwrt上网设置</h2><p>浏览器访问ip，各固件密码见<a href=/posts/%e6%95%99%e7%a8%8b%e4%b8%80%e8%bd%af%e8%b7%af%e7%94%b1%e4%bb%8b%e7%bb%8d%e5%9b%ba%e4%bb%b6%e4%bd%bf%e7%94%a8%e4%bd%93%e9%aa%8c%e5%af%b9%e6%af%94/ rel>上一期教学文章</a>。登录后设置root密码，方便ssh</p><p>网络-接口，可以发现一个lan，就是pve默认给我们添加的虚拟网口，一个wan一个wan6，其实他们俩是同一个直通网口，还有一个直通网口没使用到</p><p>点击wan，切换pppoe协议，设置拨号</p><p>点击lan-物理，选到另一个还没使用的直通网口，勾选上，进行桥接</p><p>点击lan，设置网口，设置子网掩码，设置网关为软路由地址，设置广播为软路由ip段的255地址</p><p>在lan-DHCP中，可为接入路由的设备指定dns服务器，填<code>6,[openwrt ip],223.6.6.6</code></p><p>保存&应用，搞定！ 可以上网了</p><p>如果本机仍不可上网，试试软路由的shell操作能不能上网，如果openwrt能上网，但是本机不能，建议重启本机</p><p>其余静态ip、防火墙端口转发等可以自行研究</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-10-23</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/soft-routing-guide-1/ class=prev rel=prev title=【教程一】软路由介绍，固件使用体验对比><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>【教程一】软路由介绍，固件使用体验对比</a>
<a href=/posts/soft-routing-guide-3/ class=next rel=next title="【教程三】软路由科学上网,openclash,openwrt IPv6配置">【教程三】软路由科学上网,openclash,openwrt IPv6配置<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>收藏<a target=_blank href=https://github.com/Hugh357/hugh357.github.io class=mylink>永久发布网址</a>不迷路<style>.mylink{color:#2d96bd}.mylink:hover{color:#ef3982}</style></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>阿修</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://unpkg.com/@highlightjs/cdn-assets@11.6.0/styles/default.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://unpkg.com/@highlightjs/cdn-assets@11.6.0/highlight.min.js></script><script type=text/javascript src=https://code.jquery.com/jquery-3.6.1.min.js></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js></script><script type=text/javascript src=https://www.hughh.top/js/custom.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},search:{algoliaAppID:"UAON5KYURS",algoliaIndex:"hugo",algoliaSearchKey:"9f5513387f47262e4eb64358ddfae239",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>